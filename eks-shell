#!/usr/bin/env bash
set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Default values
ENV=""
TYPE="web"
POD_NUM=""
NAMESPACE="cms"

usage() {
    echo -e "${CYAN}${BOLD}ðŸš€ EKS Shell - Connect to Kubernetes pods easily${NC}\n"
    cat <<EOF
Usage: $(basename "$0") [--env <prod|dev|stg>] [--type <pattern>] [--pod <number>]

Options:
    --env   Environment (prod, dev, stg) - auto-detects from current context if omitted
    --type  Pod name pattern to filter (default: web)
    --pod   Pod number to connect to (from the numbered list)
    -h      Show this help

Defaults: namespace=cms, type=web, env=auto-detect

Examples:
    $(basename "$0")                                # List web pods on current env
    $(basename "$0") --pod 1                        # Connect to web pod #1
    $(basename "$0") --env prod --type api          # List api pods on prod
    $(basename "$0") --env prod --type web --pod 1  # Connect to specific pod
EOF
    exit 1
}

info()    { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
success() { echo -e "${GREEN}âœ… $1${NC}"; }
warn()    { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
error()   { echo -e "${RED}âŒ $1${NC}"; exit 1; }

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --env)  ENV="$2"; shift 2 ;;
        --type) TYPE="$2"; shift 2 ;;
        --pod)  POD_NUM="$2"; shift 2 ;;
        -h|--help) usage ;;
        *) error "Unknown option: $1" ;;
    esac
done

# If no env specified, detect from current kubeconfig
if [[ -z "$ENV" ]]; then
    CURRENT_CONTEXT=$(kubectl config current-context 2>/dev/null || echo "")
    if [[ "$CURRENT_CONTEXT" == *"prod"* ]]; then
        ENV="prod"
    elif [[ "$CURRENT_CONTEXT" == *"dev"* ]]; then
        ENV="dev"
    elif [[ "$CURRENT_CONTEXT" == *"stg"* ]]; then
        ENV="stg"
    else
        warn "No --env specified and couldn't detect from current context"
        usage
    fi
    info "Detected environment: ${BOLD}$ENV${NC}${BLUE} (from current context)${NC}"
fi

# Map environment to EKS cluster name
case $ENV in
    prod) CLUSTER="prod-eks"; ENV_EMOJI="ðŸ”´" ;;
    dev)  CLUSTER="dev-eks";  ENV_EMOJI="ðŸŸ¢" ;;
    stg)  CLUSTER="stg-eks";  ENV_EMOJI="ðŸŸ¡" ;;
    *)    error "Invalid environment '$ENV'" ;;
esac

REGION="us-east-1"

# Check AWS SSO session
info "Checking AWS SSO session..."
if ! aws sts get-caller-identity &>/dev/null; then
    warn "SSO session expired. Logging in..."
    aws sso login
fi
success "AWS session active"

# Update kubeconfig
info "Updating kubeconfig for ${BOLD}$CLUSTER${NC}${BLUE}...${NC}"
aws eks update-kubeconfig --name "$CLUSTER" --region "$REGION" >/dev/null
success "Connected to ${BOLD}$CLUSTER${NC}"

# Get matching pods
info "Fetching pods matching '${BOLD}$TYPE${NC}${BLUE}' in namespace '${BOLD}$NAMESPACE${NC}${BLUE}'...${NC}"
mapfile -t PODS < <(kubectl get pod -n "$NAMESPACE" --no-headers 2>/dev/null | grep "$TYPE" | awk '{print $1}')

if [[ ${#PODS[@]} -eq 0 ]]; then
    error "No pods found matching '$TYPE'"
fi

# List pods with numbers
echo ""
echo -e "${MAGENTA}${BOLD}ðŸ“¦ Matching pods:${NC}"
for i in "${!PODS[@]}"; do
    echo -e "   ${CYAN}${BOLD}$((i+1)).${NC} ${PODS[$i]}"
done
echo ""

# If no pod number specified, just list and exit
if [[ -z "$POD_NUM" ]]; then
    echo -e "${YELLOW}ðŸ‘† Use ${BOLD}--pod <number>${NC}${YELLOW} to connect${NC}"
    exit 0
fi

# Validate pod number
if ! [[ "$POD_NUM" =~ ^[0-9]+$ ]] || [[ "$POD_NUM" -lt 1 ]] || [[ "$POD_NUM" -gt ${#PODS[@]} ]]; then
    error "Invalid pod number '$POD_NUM'. Choose 1-${#PODS[@]}"
fi

POD_NAME="${PODS[$((POD_NUM-1))]}"
PROMPT_LABEL="${ENV}-${TYPE}-${POD_NUM}"

echo -e "${GREEN}ðŸ”— Connecting to: ${BOLD}$POD_NAME${NC}"
echo -e "${CYAN}ðŸ’» Prompt: ${BOLD}${PROMPT_LABEL} \$ ${NC}"
echo ""

# Execute into the pod with custom prompt via env vars
# EKS_LABEL can be used by container's .bashrc to set PS1
kubectl exec -it "$POD_NAME" -n "$NAMESPACE" -- env \
    EKS_ENV="$ENV" \
    EKS_TYPE="$TYPE" \
    EKS_POD_NUM="$POD_NUM" \
    EKS_LABEL="$PROMPT_LABEL" \
    EKS_EMOJI="$ENV_EMOJI" \
    bash -c 'export PS1="${EKS_EMOJI} \[\033[1;36m\]${EKS_LABEL}\[\033[0m\] \$ "; exec bash --norc --noprofile'
