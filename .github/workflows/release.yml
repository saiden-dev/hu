name: release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  wait-for-builds:
    name: wait-for-builds
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.check.outputs.ready }}
    steps:
      - name: Wait for all build workflows
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = [
              'build-amd-linux',
              'build-arm-linux',
              'build-macos',
              'build-deb-amd',
              'build-deb-arm'
            ];

            const maxAttempts = 60;
            const delayMs = 30000;

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              console.log(`Attempt ${attempt}/${maxAttempts}`);

              let allComplete = true;
              let anyFailed = false;

              for (const workflow of workflows) {
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: `${workflow}.yml`,
                  head_sha: context.sha,
                  per_page: 1
                });

                if (runs.data.workflow_runs.length === 0) {
                  console.log(`${workflow}: not started yet`);
                  allComplete = false;
                } else {
                  const run = runs.data.workflow_runs[0];
                  console.log(`${workflow}: ${run.status} (${run.conclusion || 'pending'})`);

                  if (run.status !== 'completed') {
                    allComplete = false;
                  } else if (run.conclusion !== 'success') {
                    anyFailed = true;
                  }
                }
              }

              if (anyFailed) {
                core.setFailed('One or more build workflows failed');
                return;
              }

              if (allComplete) {
                core.setOutput('ready', 'true');
                return;
              }

              if (attempt < maxAttempts) {
                await new Promise(r => setTimeout(r, delayMs));
              }
            }

            core.setFailed('Timed out waiting for build workflows');

  release:
    name: release
    needs: wait-for-builds
    runs-on: ubuntu-latest
    environment: release
    steps:
      - name: Get build run IDs
        id: runs
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = [
              'build-amd-linux',
              'build-arm-linux',
              'build-macos',
              'build-deb-amd',
              'build-deb-arm'
            ];

            const runIds = [];
            for (const workflow of workflows) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: `${workflow}.yml`,
                head_sha: context.sha,
                per_page: 1
              });
              if (runs.data.workflow_runs.length > 0) {
                runIds.push(runs.data.workflow_runs[0].id);
              }
            }
            core.setOutput('run_ids', runIds.join(','));

      - name: Download artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runIds = '${{ steps.runs.outputs.run_ids }}'.split(',');

            fs.mkdirSync('artifacts', { recursive: true });

            for (const runId of runIds) {
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: parseInt(runId)
              });

              for (const artifact of artifacts.data.artifacts) {
                console.log(`Downloading ${artifact.name}`);
                const download = await github.rest.actions.downloadArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                  archive_format: 'zip'
                });

                fs.writeFileSync(`artifacts/${artifact.name}.zip`, Buffer.from(download.data));
              }
            }

      - name: Extract artifacts
        run: |
          cd artifacts
          for f in *.zip; do
            unzip -o "$f"
            rm "$f"
          done
          ls -la

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*
          generate_release_notes: true

  publish-crates:
    name: publish-crates
    needs: wait-for-builds
    runs-on: ubuntu-latest
    environment:
      name: crates-io
      url: https://crates.io/crates/hu
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        run: cargo publish --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
